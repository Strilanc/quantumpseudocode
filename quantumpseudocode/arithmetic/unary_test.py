import cirq

import quantumpseudocode as qp


def test_let_unary_circuit():
    with qp.Sim():
        b = qp.qalloc(len=3, name='b')
        u = qp.qalloc(len=8, name='u')
        c = qp.qalloc(name='_c')
        with qp.LogCirqCircuit() as circuit:
            (1 << b).init_storage_location(u, c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: -----@-----------------------------------------------------------
         |
b[0]: ---|---@-------------------------------------------------------
         |   |
b[1]: ---|---|-------@-------@---------------------------------------
         |   |       |       |
b[2]: ---|---|-------|-------|-------@-------@-------@-------@-------
         |   |       |       |       |       |       |       |
u[0]: ---X---@---X---@---X---|-------@---X---|-------|-------|-------
             |   |   |   |   |       |   |   |       |       |
u[1]: -------X---@---|---|---@---X---|---|---@---X---|-------|-------
                     |   |   |   |   |   |   |   |   |       |
u[2]: ---------------X---@---|---|---|---|---|---|---@---X---|-------
                             |   |   |   |   |   |   |   |   |
u[3]: -----------------------X---@---|---|---|---|---|---|---@---X---
                                     |   |   |   |   |   |   |   |
u[4]: -------------------------------X---@---|---|---|---|---|---|---
                                             |   |   |   |   |   |
u[5]: ---------------------------------------X---@---|---|---|---|---
                                                     |   |   |   |
u[6]: -----------------------------------------------X---@---|---|---
                                                             |   |
u[7]: -------------------------------------------------------X---@---
        """, use_unicode_characters=False)


def test_xor_unary_circuit():
    with qp.Sim(phase_fixup_bias=True):
        b = qp.qalloc(len=3, name='b')
        u = qp.qalloc(len=8, name='u')
        c = qp.qalloc(name='_c')
        with qp.LogCirqCircuit() as circuit:
            u ^= (1 << b) & qp.controlled_by(c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: -------------------------@---@-------------------------------------------------------------------------------------------------------------------------------------------------------------@-------------------------------------------------------------------------------------------------------------------------------------------------------------------@-------------------
                             |   |                                                                                                                                                             |                                                                                                                                                                   |
_lookup_prefix: -----alloc---X---X-----------@---@---------------------------------------------------------@---------------------------------------------------------------@-------------------X-----------@---@---------------------------------------------------------@---------------------------------------------------------------@-------------------Mxc---|---cxM---release---
                             |               |   |                                                         |                                                               |                               |   |                                                         |                                                               |                         |
_lookup_prefix_1: -----------|-------alloc---X---X-----------@---@-------@-------------@-------------------X-----------@---@-------@-------------@-------------------Mxc---|---cxM---release-------alloc---X---X-----------@---@-------@-------------@-------------------X-----------@---@-------@-------------@-------------------Mxc---|---cxM---release---------|-------------------
                             |               |               |   |       |             |                               |   |       |             |                         |                               |               |   |       |             |                               |   |       |             |                         |                         |
_lookup_prefix_2: -----------|---------------|-------alloc---X---X---@---X---@---Mxc---|---cxM---release-------alloc---X---X---@---X---@---Mxc---|---cxM---release---------|-------------------------------|-------alloc---X---X---@---X---@---Mxc---|---cxM---release-------alloc---X---X---@---X---@---Mxc---|---cxM---release---------|-------------------------|-------------------
                             |               |               |       |       |         |                               |       |       |         |                         |                               |               |       |       |         |                               |       |       |         |                         |                         |
b[0]: -----------------------|---------------|---------------@-------|-------|---------Z-------------------------------@-------|-------|---------Z-------------------------|-------------------------------|---------------@-------|-------|---------Z-------------------------------@-------|-------|---------Z-------------------------|-------------------------|-------------------
                             |               |                       |       |                                                 |       |                                   |                               |                       |       |                                                 |       |                                   |                         |
b[1]: -----------------------|---------------@-----------------------|-------|-------------------------------------------------|-------|-----------------------------------Z-------------------------------@-----------------------|-------|-------------------------------------------------|-------|-----------------------------------Z-------------------------|-------------------
                             |                                       |       |                                                 |       |                                                                                           |       |                                                 |       |                                                             |
b[2]: -----------------------@---------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------Z-------------------
                                                                     |       |                                                 |       |                                                                                           |       |                                                 |       |
u[0]: ---------------------------------------------------------------X-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                             |                                                 |       |                                                                                           |       |                                                 |       |
u[1]: -----------------------------------------------------------------------X-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                                                                               |       |                                                                                           |       |                                                 |       |
u[2]: -------------------------------------------------------------------------------------------------------------------------X-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                                                                                       |                                                                                           |       |                                                 |       |
u[3]: ---------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                                                                                                                                                                                   |       |                                                 |       |
u[4]: -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------|-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                                                                                                                                                                                           |                                                 |       |
u[5]: -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------|-------|---------------------------------------------------------------------------------
                                                                                                                                                                                                                                                                                             |       |
u[6]: ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------|---------------------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                     |
u[7]: -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X---------------------------------------------------------------------------------
        """, use_unicode_characters=False)


def test_del_unary_circuit():
    with qp.Sim(phase_fixup_bias=True):
        b = qp.qalloc(len=3, name='b')
        u = qp.qalloc(len=8, name='u')
        c = qp.qalloc(name='_c')
        with qp.LogCirqCircuit() as circuit:
            (1 << b).clear_storage_location(u, c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: -------------------------------------------------------------------------------------------------------------------------------------------------------Z---------

b[0]: -------------------------------------------------------------------------------------------------------------------------------------Z-------------------------
                                                                                                                                           |
b[1]: ---------------------------------------------------------------------------------------------Z-------------------Z-------------------|-------------------------
                                                                                                   |                   |                   |
b[2]: -------------Z-------------------Z-------------------Z-------------------Z-------------------|-------------------|-------------------|-------------------------
                   |                   |                   |                   |                   |                   |                   |
u[0]: -------------|-------------------|-------------------|---------X---------@-------------------|---------X---------@---------X---------@---------Mxc-------cxM---
                   |                   |                   |         |                             |         |                   |
u[1]: -------------|-------------------|---------X---------@---------|-------------------X---------@---------|-------------------@---Mxc-------cxM-------------------
                   |                   |         |                   |                   |                   |
u[2]: -------------|---------X---------@---------|-------------------|-------------------|-------------------@---Mxc-------cxM---------------------------------------
                   |         |                   |                   |                   |
u[3]: ---X---------@---------|-------------------|-------------------|-------------------@---Mxc-------cxM-----------------------------------------------------------
         |                   |                   |                   |
u[4]: ---|-------------------|-------------------|-------------------@---Mxc-------cxM-------------------------------------------------------------------------------
         |                   |                   |
u[5]: ---|-------------------|-------------------@---Mxc-------cxM---------------------------------------------------------------------------------------------------
         |                   |
u[6]: ---|-------------------@---Mxc-------cxM-----------------------------------------------------------------------------------------------------------------------
         |
u[7]: ---@---Mxc-------cxM-------------------------------------------------------------------------------------------------------------------------------------------
""", use_unicode_characters=False)

    with qp.Sim(phase_fixup_bias=False):
        b = qp.qalloc(len=3, name='b')
        u = qp.qalloc(len=8, name='u')
        c = qp.qalloc(name='_c')
        with qp.LogCirqCircuit() as circuit:
            (1 << b).clear_storage_location(u, c)

    cirq.testing.assert_has_diagram(circuit, r"""
u[0]: ---------------------------------------------------X-------------------------------X---------------X---------------Mxc---cxM---
                                                         |                               |               |
u[1]: -----------------------------------X---------------|---------------X---------------|---------------@---Mxc---cxM---------------
                                         |               |               |               |
u[2]: -------------------X---------------|---------------|---------------|---------------@---Mxc---cxM-------------------------------
                         |               |               |               |
u[3]: ---X---------------|---------------|---------------|---------------@---Mxc---cxM-----------------------------------------------
         |               |               |               |
u[4]: ---|---------------|---------------|---------------@---Mxc---cxM---------------------------------------------------------------
         |               |               |
u[5]: ---|---------------|---------------@---Mxc---cxM-------------------------------------------------------------------------------
         |               |
u[6]: ---|---------------@---Mxc---cxM-----------------------------------------------------------------------------------------------
         |
u[7]: ---@---Mxc---cxM---------------------------------------------------------------------------------------------------------------
        """, use_unicode_characters=False)
