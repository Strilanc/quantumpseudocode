import cirq

import quantumpseudocode as qp


def test_let_unary_circuit():
    with qp.Sim():
        with qp.LogCirqCircuit() as circuit:
            with qp.qalloc_int(bits=3, name='b') as b:
                with qp.qalloc_int(bits=8, name='u') as u:
                    with qp.qalloc(name='_c') as c:
                        u.init(1 << b, c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: ---------------------alloc---@-----------------------------------------------------------release-----------------------
                                 |
b[0]: ---alloc-------------------|---@---------------------------------------------------------------------------release---
         |                       |   |                                                                           |
b[1]: ---alloc-------------------|---|-------@-------@-----------------------------------------------------------release---
         |                       |   |       |       |                                                           |
b[2]: ---alloc-------------------|---|-------|-------|-------@-------@-------@-------@---------------------------release---
                                 |   |       |       |       |       |       |       |
u[0]: -----------alloc-----------X---@---X---@---X---|-------@---X---|-------|-------|-----------------release-------------
                 |                   |   |   |   |   |       |   |   |       |       |                 |
u[1]: -----------alloc---------------X---@---|---|---@---X---|---|---@---X---|-------|-----------------release-------------
                 |                           |   |   |   |   |   |   |   |   |       |                 |
u[2]: -----------alloc-----------------------X---@---|---|---|---|---|---|---@---X---|-----------------release-------------
                 |                                   |   |   |   |   |   |   |   |   |                 |
u[3]: -----------alloc-------------------------------X---@---|---|---|---|---|---|---@---X-------------release-------------
                 |                                           |   |   |   |   |   |   |   |             |
u[4]: -----------alloc---------------------------------------X---@---|---|---|---|---|---|-------------release-------------
                 |                                                   |   |   |   |   |   |             |
u[5]: -----------alloc-----------------------------------------------X---@---|---|---|---|-------------release-------------
                 |                                                           |   |   |   |             |
u[6]: -----------alloc-------------------------------------------------------X---@---|---|-------------release-------------
                 |                                                                   |   |             |
u[7]: -----------alloc---------------------------------------------------------------X---@-------------release-------------
        """, use_unicode_characters=False)


def test_xor_unary_circuit():
    with qp.Sim(phase_fixup_bias=True):
        with qp.LogCirqCircuit() as circuit:
            with qp.qalloc_int(bits=3, name='b') as b:
                with qp.qalloc_int(bits=8, name='u') as u:
                    with qp.qalloc(name='_c') as c:
                        u ^= (1 << b) & qp.controlled_by(c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: ---------------------------------alloc-----------@---@-------------------------------------------------------------------------------------------------------------------------------------------------------------@-------------------------------------------------------------------------------------------------------------------------------------------------------------------@-------------------release-----------------------
                                                     |   |                                                                                                                                                             |                                                                                                                                                                   |
_lookup_prefix: -----------------------------alloc---X---X-----------@---@---------------------------------------------------------@---------------------------------------------------------------@-------------------X-----------@---@---------------------------------------------------------@---------------------------------------------------------------@-------------------Mxc---|---cxM---release---------------------------------
                                                     |               |   |                                                         |                                                               |                               |   |                                                         |                                                               |                         |
_lookup_prefix_1: -----------------------------------|-------alloc---X---X-----------@---@-------@-------------@-------------------X-----------@---@-------@-------------@-------------------Mxc---|---cxM---release-------alloc---X---X-----------@---@-------@-------------@-------------------X-----------@---@-------@-------------@-------------------Mxc---|---cxM---release---------|-------------------------------------------------
                                                     |               |               |   |       |             |                               |   |       |             |                         |                               |               |   |       |             |                               |   |       |             |                         |                         |
_lookup_prefix_2: -----------------------------------|---------------|-------alloc---X---X---@---X---@---Mxc---|---cxM---release-------alloc---X---X---@---X---@---Mxc---|---cxM---release---------|-------------------------------|-------alloc---X---X---@---X---@---Mxc---|---cxM---release-------alloc---X---X---@---X---@---Mxc---|---cxM---release---------|-------------------------|-------------------------------------------------
                                                     |               |               |       |       |         |                               |       |       |         |                         |                               |               |       |       |         |                               |       |       |         |                         |                         |
b[0]: ---------------alloc---------------------------|---------------|---------------@-------|-------|---------Z-------------------------------@-------|-------|---------Z-------------------------|-------------------------------|---------------@-------|-------|---------Z-------------------------------@-------|-------|---------Z-------------------------|-------------------------|---------------------------------------release---
                     |                               |               |                       |       |                                                 |       |                                   |                               |                       |       |                                                 |       |                                   |                         |                                       |
b[1]: ---------------alloc---------------------------|---------------@-----------------------|-------|-------------------------------------------------|-------|-----------------------------------Z-------------------------------@-----------------------|-------|-------------------------------------------------|-------|-----------------------------------Z-------------------------|---------------------------------------release---
                     |                               |                                       |       |                                                 |       |                                                                                           |       |                                                 |       |                                                             |                                       |
b[2]: ---------------alloc---------------------------@---------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------Z---------------------------------------release---
                                                                                             |       |                                                 |       |                                                                                           |       |                                                 |       |
u[0]: -----------------------alloc-----------------------------------------------------------X-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                       |                                                 |       |                                                                                           |       |                                                 |       |                                                                                           |
u[1]: -----------------------alloc-------------------------------------------------------------------X-------------------------------------------------|-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                         |       |                                                                                           |       |                                                 |       |                                                                                           |
u[2]: -----------------------alloc---------------------------------------------------------------------------------------------------------------------X-------|-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                                 |                                                                                           |       |                                                 |       |                                                                                           |
u[3]: -----------------------alloc-----------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------------------------------------------------|-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                                                                                                                             |       |                                                 |       |                                                                                           |
u[4]: -----------------------alloc-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------|-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                                                                                                                                     |                                                 |       |                                                                                           |
u[5]: -----------------------alloc---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------|-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                                                                                                                                                                                       |       |                                                                                           |
u[6]: -----------------------alloc-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------|-------------------------------------------------------------------------------------------release-------------
                             |                                                                                                                                                                                                                                                                                               |                                                                                           |
u[7]: -----------------------alloc-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------------------------------------------------release-------------
        """, use_unicode_characters=False)


def test_del_unary_circuit():
    with qp.Sim(phase_fixup_bias=True):
        with qp.LogCirqCircuit() as circuit:
            with qp.qalloc_int(bits=3, name='b') as b:
                with qp.qalloc_int(bits=8, name='u') as u:
                    with qp.qalloc(name='_c') as c:
                        u.clear(1 << b, c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: ---------------------alloc-----------------------------------------------------------------------------------------------------------------------------------------------------Z---------release-----------------------

b[0]: ---alloc-----------------------------------------------------------------------------------------------------------------------------------------------------Z---------------------------------------------release---
         |                                                                                                                                                         |                                             |
b[1]: ---alloc-------------------------------------------------------------------------------------------------------------Z-------------------Z-------------------|---------------------------------------------release---
         |                                                                                                                 |                   |                   |                                             |
b[2]: ---alloc-----------------------------Z-------------------Z-------------------Z-------------------Z-------------------|-------------------|-------------------|---------------------------------------------release---
                                           |                   |                   |                   |                   |                   |                   |
u[0]: -----------alloc---------------------|-------------------|-------------------|---------X---------@-------------------|---------X---------@---------X---------@---------Mxc-------cxM-------------release-------------
                 |                         |                   |                   |         |                             |         |                   |                                             |
u[1]: -----------alloc---------------------|-------------------|---------X---------@---------|-------------------X---------@---------|-------------------@---Mxc-------cxM-----------------------------release-------------
                 |                         |                   |         |                   |                   |                   |                                                                 |
u[2]: -----------alloc---------------------|---------X---------@---------|-------------------|-------------------|-------------------@---Mxc-------cxM-------------------------------------------------release-------------
                 |                         |         |                   |                   |                   |                                                                                     |
u[3]: -----------alloc-----------X---------@---------|-------------------|-------------------|-------------------@---Mxc-------cxM---------------------------------------------------------------------release-------------
                 |               |                   |                   |                   |                                                                                                         |
u[4]: -----------alloc-----------|-------------------|-------------------|-------------------@---Mxc-------cxM-----------------------------------------------------------------------------------------release-------------
                 |               |                   |                   |                                                                                                                             |
u[5]: -----------alloc-----------|-------------------|-------------------@---Mxc-------cxM-------------------------------------------------------------------------------------------------------------release-------------
                 |               |                   |                                                                                                                                                 |
u[6]: -----------alloc-----------|-------------------@---Mxc-------cxM---------------------------------------------------------------------------------------------------------------------------------release-------------
                 |               |                                                                                                                                                                     |
u[7]: -----------alloc-----------@---Mxc-------cxM-----------------------------------------------------------------------------------------------------------------------------------------------------release-------------
""", use_unicode_characters=False)

    del u
    del b
    del c
    with qp.Sim(phase_fixup_bias=False):
        with qp.LogCirqCircuit() as circuit:
            with qp.qalloc_int(bits=3, name='b') as b:
                with qp.qalloc_int(bits=8, name='u') as u:
                    with qp.qalloc(name='_c') as c:
                        u.clear(1 << b, c)

    cirq.testing.assert_has_diagram(circuit, r"""
_c: ---------------------alloc-------------------------------------------------------------------------------------------------------------------------------release-----------------------

b[0]: ---alloc-------------------------------------------------------------------------------------------------------------------------------------------------------------------release---
         |                                                                                                                                                                       |
b[1]: ---alloc-------------------------------------------------------------------------------------------------------------------------------------------------------------------release---
         |                                                                                                                                                                       |
b[2]: ---alloc-------------------------------------------------------------------------------------------------------------------------------------------------------------------release---

u[0]: -----------alloc-----------------------------------------------------------X-------------------------------X---------------X---------------Mxc---cxM-------------release-------------
                 |                                                               |                               |               |                                     |
u[1]: -----------alloc-------------------------------------------X---------------|---------------X---------------|---------------@---Mxc---cxM-------------------------release-------------
                 |                                               |               |               |               |                                                     |
u[2]: -----------alloc---------------------------X---------------|---------------|---------------|---------------@---Mxc---cxM-----------------------------------------release-------------
                 |                               |               |               |               |                                                                     |
u[3]: -----------alloc-----------X---------------|---------------|---------------|---------------@---Mxc---cxM---------------------------------------------------------release-------------
                 |               |               |               |               |                                                                                     |
u[4]: -----------alloc-----------|---------------|---------------|---------------@---Mxc---cxM-------------------------------------------------------------------------release-------------
                 |               |               |               |                                                                                                     |
u[5]: -----------alloc-----------|---------------|---------------@---Mxc---cxM-----------------------------------------------------------------------------------------release-------------
                 |               |               |                                                                                                                     |
u[6]: -----------alloc-----------|---------------@---Mxc---cxM---------------------------------------------------------------------------------------------------------release-------------
                 |               |                                                                                                                                     |
u[7]: -----------alloc-----------@---Mxc---cxM-------------------------------------------------------------------------------------------------------------------------release-------------
        """, use_unicode_characters=False)
