import cirq

import quantumpseudocode as qp


def test_xor_lookup():
    with qp.Sim(phase_fixup_bias=True, enforce_release_at_zero=False):
        with qp.LogCirqCircuit() as circuit:
            with qp.qmanaged_int(bits=4, name='addr') as addr:
                with qp.qmanaged_int(bits=8, name='out') as out:
                    with qp.qmanaged(name='cnt') as cnt:
                        with qp.controlled_by(cnt):
                            out ^= qp.LookupTable(range(1, 17))[addr]

    cirq.testing.assert_has_diagram(circuit, r"""
_lookup_prefix: -----X---X---@---@-------------------------------------------------------------------------------------@-------------------------------------------------------------------------------------------@---X---@---@-------------------------------------------------------------------------------------@-------------------------------------------------------------------------------------------@---Mxc-------
                     |   |   |   |                                                                                     |                                                                                           |   |   |   |                                                                                     |                                                                                           |
_lookup_prefix_1: ---|---|---X---X---@---@---------------------------------@---------------------------------------@---X---@---@---------------------------------@---------------------------------------@---Mxc---|---|---X---X---@---@---------------------------------@---------------------------------------@---X---@---@---------------------------------@---------------------------------------@---Mxc---|-------------
                     |   |   |       |   |                                 |                                       |       |   |                                 |                                       |         |   |   |       |   |                                 |                                       |       |   |                                 |                                       |         |
_lookup_prefix_2: ---|---|---|-------X---X---@---@-------@-------------@---X---@---@-------@-------------@---Mxc---|-------X---X---@---@-------@-------------@---X---@---@-------@-------------@---Mxc---|---------|---|---|-------X---X---@---@-------@-------------@---X---@---@-------@-------------@---Mxc---|-------X---X---@---@-------@-------------@---X---@---@-------@-------------@---Mxc---|---------|-------------
                     |   |   |       |       |   |       |             |       |   |       |             |         |       |       |   |       |             |       |   |       |             |         |         |   |   |       |       |   |       |             |       |   |       |             |         |       |       |   |       |             |       |   |       |             |         |         |
_lookup_prefix_3: ---|---|---|-------|-------X---X---@---X---@---Mxc---|-------X---X---@---X---@---Mxc---|---------|-------|-------X---X---@---X---@---Mxc---|-------X---X---@---X---@---Mxc---|---------|---------|---|---|-------|-------X---X---@---X---@---Mxc---|-------X---X---@---X---@---Mxc---|---------|-------|-------X---X---@---X---@---Mxc---|-------X---X---@---X---@---Mxc---|---------|---------|-------------
                     |   |   |       |       |       |       |         |       |       |       |         |         |       |       |       |       |         |       |       |       |         |         |         |   |   |       |       |       |       |         |       |       |       |         |         |       |       |       |       |         |       |       |       |         |         |         |
addr[0]: ------------|---|---|-------|-------@-------|-------|---------Z-------@-------|-------|---------Z---------|-------|-------@-------|-------|---------Z-------@-------|-------|---------Z---------|---------|---|---|-------|-------@-------|-------|---------Z-------@-------|-------|---------Z---------|-------|-------@-------|-------|---------Z-------@-------|-------|---------Z---------|---------|-------------
                     |   |   |       |               |       |                         |       |                   |       |               |       |                         |       |                   |         |   |   |       |               |       |                         |       |                   |       |               |       |                         |       |                   |         |
addr[1]: ------------|---|---|-------@---------------|-------|-------------------------|-------|-------------------Z-------@---------------|-------|-------------------------|-------|-------------------Z---------|---|---|-------@---------------|-------|-------------------------|-------|-------------------Z-------@---------------|-------|-------------------------|-------|-------------------Z---------|-------------
                     |   |   |                       |       |                         |       |                                           |       |                         |       |                             |   |   |                       |       |                         |       |                                           |       |                         |       |                             |
addr[2]: ------------|---|---@-----------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|-----------------------------Z---|---@-----------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|-----------------------------Z-------------
                     |   |                           |       |                         |       |                                           |       |                         |       |                                 |                           |       |                         |       |                                           |       |                         |       |
addr[3]: ------------@---|---------------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|---------------------------------|---------------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|---------------------------------------Z---
                     |   |                           |       |                         |       |                                           |       |                         |       |                                 |                           |       |                         |       |                                           |       |                         |       |                                       |
cnt: ----------------@---@---------------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|---------------------------------@---------------------------|-------|-------------------------|-------|-------------------------------------------|-------|-------------------------|-------|---------------------------------------@---
                                                     |       |                         |       |                                           |       |                         |       |                                                             |       |                         |       |                                           |       |                         |       |
out[0]: ---------------------------------------------X-------|-------------------------X-------|-------------------------------------------X-------|-------------------------X-------|-------------------------------------------------------------X-------|-------------------------X-------|-------------------------------------------X-------|-------------------------X-------|-------------------------------------------
                                                             |                         |       |                                           |       |                         |       |                                                             |       |                         |       |                                           |       |                         |       |
out[1]: -----------------------------------------------------X-------------------------X-------|-------------------------------------------|-------X-------------------------X-------|-------------------------------------------------------------|-------X-------------------------X-------|-------------------------------------------|-------X-------------------------X-------|-------------------------------------------
                                                                                               |                                           |       |                         |       |                                                             |       |                         |       |                                           |       |                         |       |
out[2]: ---------------------------------------------------------------------------------------X-------------------------------------------X-------X-------------------------X-------|-------------------------------------------------------------|-------|-------------------------|-------X-------------------------------------------X-------X-------------------------X-------|-------------------------------------------
                                                                                                                                                                                     |                                                             |       |                         |       |                                           |       |                         |       |
out[3]: -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------------------------X-------X-------------------------X-------X-------------------------------------------X-------X-------------------------X-------|-------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                   |
out[4]: ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------X-------------------------------------------
        """, use_unicode_characters=False)


def test_redundant_lookup():
    with qp.Sim(phase_fixup_bias=True, enforce_release_at_zero=False):
        with qp.LogCirqCircuit() as circuit:
            with qp.qmanaged_int(bits=4, name='addr') as addr:
                with qp.qmanaged_int(bits=8, name='out') as out:
                    with qp.qmanaged(name='cnt') as cnt:
                        with qp.controlled_by(cnt):
                            out ^= qp.LookupTable([3] * 16)[addr]

    cirq.testing.assert_has_diagram(circuit, r"""
addr[0]: ---X-------X---
            |       |
addr[1]: ---X-------X---
            |       |
addr[2]: ---X-------X---
            |       |
addr[3]: ---X-------X---

cnt: -----------@-------
                |
out[0]: --------X-------
                |
out[1]: --------X-------
        """, use_unicode_characters=False)


def test_del_lookup():
    with qp.Sim(phase_fixup_bias=True, enforce_release_at_zero=False):
        with qp.LogCirqCircuit() as circuit:
            with qp.qmanaged_int(bits=4, name='addr') as addr:
                    with qp.qmanaged(name='cnt'):
                        with qp.hold(qp.LookupTable(range(1, 17))[addr], name='out'):
                            circuit[:] = []

    cirq.testing.assert_has_diagram(circuit, r"""
_lookup_prefix: ---------------------------------------------------------------X---X---@---@-------@-------------@---X---@---@-------@-------------@---Mxc-------------------------------------------------------
                                                                               |       |   |       |             |       |   |       |             |
_lookup_prefix_1: -------------------------------------------------------------|-------X---X---@---X---@---Mxc---|-------X---X---@---X---@---Mxc---|-------------------------------------------------------------
                                                                               |       |       |       |         |       |       |       |         |
addr[0]: ----------------------------------------------@-----------------------|-------|-------|-------|---------|-------|-------|-------|---------|---------------------------------------------------Z---------
                                                       |                       |       |       |       |         |       |       |       |         |                                                   |
addr[1]: ----------------------------------------------|-------@-------@-------|-------|-------|-------|---------|-------|-------|-------|---------|-----------------------Z-------------Z-------------|---------
                                                       |       |       |       |       |       |       |         |       |       |       |         |                       |             |             |
addr[2]: ----------------------------------------------|-------|-------|-------|-------@-------|-------|---------Z-------@-------|-------|---------Z-----------------------|-------------|-------------|---------
                                                       |       |       |       |               |       |                         |       |                                 |             |             |
addr[3]: ----------------------------------------------|-------|-------|-------@---------------|-------|-------------------------|-------|-------------------Z-------------|-------------|-------------|---------
                                                       |       |       |                       |       |                         |       |                                 |             |             |
out[0]: -------------Mxc---------------------------X---@---X---@---X---|-----------------------X-------|-------------------------|-------X---------------------------------|---X---------@---X---------@---Mxc---
                                                       |   |   |   |   |                       |       |                         |       |                                 |   |             |
out[1]: -------------------Mxc-------------------------X---@---|---|---@---X-------------------X-------|-------------------------|-------X-----------------------X---------@---|-------------@---Mxc-------------
                                                               |   |   |   |                   |       |                         |       |                       |             |
out[2]: -------------------------Mxc---------------------------X---@---|---|-------------------|-------X-------------------------X-------|-----------------------|-------------@---Mxc---------------------------
                                                                       |   |                   |       |                                 |                       |
out[3]: -------------------------------Mxc-----------------------------X---@-------------------X-------X---------------------------------X-----------------------@---Mxc-----------------------------------------

out[4]: -------------------------------------Mxc-----------------------------------------------------------------------------------------------------------------------------------------------------------------
        """, use_unicode_characters=False)
